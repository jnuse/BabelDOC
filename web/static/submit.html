<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æäº¤ç¿»è¯‘ä»»åŠ¡ - BabelDOC</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <h1 class="nav-title">ğŸ“„ BabelDOC</h1>
            <div class="nav-links">
                <a href="submit.html" class="active">æäº¤ä»»åŠ¡</a>
                <a href="tasks.html">ä»»åŠ¡åˆ—è¡¨</a>
            </div>
        </div>
    </nav>

    <div class="container">
        <h2>ğŸ“¤ æäº¤ç¿»è¯‘ä»»åŠ¡</h2>
        
        <form id="submitForm" class="task-form">
            <div class="form-group">
                <label for="file">é€‰æ‹©PDFæ–‡ä»¶ *</label>
                <input type="file" id="file" name="file" accept=".pdf" required>
                <div class="help-text">æ”¯æŒæœ€å¤§100MBçš„PDFæ–‡ä»¶</div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="lang_in">æºè¯­è¨€</label>
                    <select id="lang_in" name="lang_in">
                        <option value="en">è‹±è¯­ (English)</option>
                        <option value="zh">ä¸­æ–‡ (Chinese)</option>
                        <option value="ja">æ—¥è¯­ (Japanese)</option>
                        <option value="ko">éŸ©è¯­ (Korean)</option>
                        <option value="fr">æ³•è¯­ (French)</option>
                        <option value="de">å¾·è¯­ (German)</option>
                        <option value="es">è¥¿ç­ç‰™è¯­ (Spanish)</option>
                        <option value="ru">ä¿„è¯­ (Russian)</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="lang_out">ç›®æ ‡è¯­è¨€</label>
                    <select id="lang_out" name="lang_out">
                        <option value="zh">ä¸­æ–‡ (Chinese)</option>
                        <option value="en">è‹±è¯­ (English)</option>
                        <option value="ja">æ—¥è¯­ (Japanese)</option>
                        <option value="ko">éŸ©è¯­ (Korean)</option>
                        <option value="fr">æ³•è¯­ (French)</option>
                        <option value="de">å¾·è¯­ (German)</option>
                        <option value="es">è¥¿ç­ç‰™è¯­ (Spanish)</option>
                        <option value="ru">ä¿„è¯­ (Russian)</option>
                    </select>
                </div>
            </div>
            
            <div class="form-group">
                <label for="pages">é¡µç èŒƒå›´ï¼ˆå¯é€‰ï¼‰</label>
                <input type="text" id="pages" name="pages" placeholder="ä¾‹å¦‚: 1-5 æˆ– 1,3,5">
                <div class="help-text">ç•™ç©ºè¡¨ç¤ºç¿»è¯‘å…¨éƒ¨é¡µé¢</div>
            </div>
            
            <!-- OpenAI é…ç½® -->
            <div class="advanced-section">
                <h3 onclick="toggleSection('openai-section')">ğŸ¤– OpenAI é…ç½® <span class="toggle-icon">â–¼</span></h3>
                <div id="openai-section" class="section-content" style="display: none;">
                    <div class="help-text" style="margin-bottom: 15px;">
                        ä¸‰ä¸ªå­—æ®µï¼ˆAPI Keyã€æ¨¡å‹ã€Base URLï¼‰è¦ä¹ˆå…¨éƒ¨å¡«å†™ï¼Œè¦ä¹ˆå…¨éƒ¨ç•™ç©ºä½¿ç”¨ç¯å¢ƒå˜é‡é»˜è®¤é…ç½®
                    </div>
                    <div class="form-group">
                        <label for="openai-api-key">API Key</label>
                        <input type="password" id="openai-api-key" name="openai-api-key" placeholder="ç•™ç©ºä½¿ç”¨ç¯å¢ƒå˜é‡">
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="openai-model">æ¨¡å‹</label>
                            <input type="text" id="openai-model" name="openai-model" placeholder="ç•™ç©ºä½¿ç”¨ç¯å¢ƒå˜é‡">
                        </div>
                        <div class="form-group">
                            <label for="openai-base-url">Base URL</label>
                            <input type="text" id="openai-base-url" name="openai-base-url" placeholder="ç•™ç©ºä½¿ç”¨ç¯å¢ƒå˜é‡">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="custom-system-prompt">è‡ªå®šä¹‰ç³»ç»Ÿæç¤ºè¯</label>
                        <input type="text" id="custom-system-prompt" name="custom-system-prompt" placeholder="å¯é€‰">
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="rate-limit-type">é€Ÿç‡é™åˆ¶ç±»å‹</label>
                            <select id="rate-limit-type" onchange="updateRateLimitInput()">
                                <option value="rpm" selected>RPM (æ¯åˆ†é’Ÿè¯·æ±‚)</option>
                                <option value="qps">QPS (æ¯ç§’æŸ¥è¯¢)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="rate-limit-value">
                                <span id="rate-limit-label">RPMé™åˆ¶</span>
                                <small style="color: #666;">(ä½é¢‘APIæ¨è)</small>
                            </label>
                            <input type="number" id="rate-limit-value" name="rpm" value="10" min="1">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="min-text-length">æœ€å°æ–‡æœ¬é•¿åº¦</label>
                            <input type="number" id="min-text-length" name="min-text-length" placeholder="5">
                        </div>
                        <div class="form-group">
                            <!-- å ä½ -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- PDF å¤„ç†é€‰é¡¹ -->
            <div class="advanced-section">
                <h3 onclick="toggleSection('pdf-section')">ğŸ“„ PDF å¤„ç†é€‰é¡¹ <span class="toggle-icon">â–¼</span></h3>
                <div id="pdf-section" class="section-content" style="display: none;">
                    <div class="form-group">
                        <label>
                            <input type="checkbox" name="skip-clean" value="true">
                            è·³è¿‡PDFæ¸…ç† (æé«˜å…¼å®¹æ€§ä½†å¢åŠ æ–‡ä»¶å¤§å°)
                        </label>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" name="enhance-compatibility" value="true">
                            å¯ç”¨æ‰€æœ‰å…¼å®¹æ€§å¢å¼ºé€‰é¡¹
                        </label>
                    </div>
                    <div class="form-group">
                        <label for="watermark-output-mode">æ°´å°è¾“å‡ºæ¨¡å¼</label>
                        <select id="watermark-output-mode" name="watermark-output-mode">
                            <option value="">é»˜è®¤ (æ·»åŠ æ°´å°)</option>
                            <option value="no_watermark">ä¸æ·»åŠ æ°´å°</option>
                            <option value="both">è¾“å‡ºä¸¤ä¸ªç‰ˆæœ¬</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="max-pages-per-part">æ¯éƒ¨åˆ†æœ€å¤§é¡µæ•°ï¼ˆåˆ†å‰²ç¿»è¯‘ï¼‰</label>
                        <input type="number" id="max-pages-per-part" name="max-pages-per-part" placeholder="ç•™ç©ºä¸åˆ†å‰²">
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" name="ignore-cache" value="true">
                            å¿½ç•¥ç¿»è¯‘ç¼“å­˜
                        </label>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" name="no-dual" value="true">
                            ä¸è¾“å‡ºåŒè¯­PDF
                        </label>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" name="no-mono" value="true">
                            ä¸è¾“å‡ºå•è¯­PDF
                        </label>
                    </div>
                </div>
            </div>
            
            <button type="submit" class="btn btn-primary" id="submitBtn">
                <span id="submitText">ğŸš€ æäº¤ä»»åŠ¡</span>
                <span id="submitSpinner" class="spinner" style="display: none;"></span>
            </button>
        </form>

        <div id="message" class="message" style="display: none;"></div>
    </div>

    <script>
        const form = document.getElementById('submitForm');
        const submitBtn = document.getElementById('submitBtn');
        const submitText = document.getElementById('submitText');
        const submitSpinner = document.getElementById('submitSpinner');
        const message = document.getElementById('message');

        // é€Ÿç‡é™åˆ¶ç±»å‹åˆ‡æ¢
        function updateRateLimitInput() {
            const type = document.getElementById('rate-limit-type').value;
            const label = document.getElementById('rate-limit-label');
            const input = document.getElementById('rate-limit-value');
            
            if (type === 'rpm') {
                label.innerHTML = 'RPMé™åˆ¶ <small style="color: #666;">(ä½é¢‘APIæ¨è)</small>';
                input.name = 'rpm';
                input.value = '10';
                input.placeholder = '10';
            } else {
                label.innerHTML = 'QPSé™åˆ¶ <small style="color: #666;">(é«˜é¢‘API)</small>';
                input.name = 'qps';
                input.value = '4';
                input.placeholder = '4';
            }
        }

        function toggleSection(sectionId) {
            const section = document.getElementById(sectionId);
            const icon = event.currentTarget.querySelector('.toggle-icon');
            if (section.style.display === 'none') {
                section.style.display = 'block';
                icon.textContent = 'â–²';
            } else {
                section.style.display = 'none';
                icon.textContent = 'â–¼';
            }
        }

        form.addEventListener('submit', async (e) => {
            e.preventDefault();

            submitBtn.disabled = true;
            submitText.style.display = 'none';
            submitSpinner.style.display = 'inline-block';

            // éªŒè¯ OpenAI ä¸‰ä¸ªå­—æ®µï¼šè¦ä¹ˆå…¨å¡«ï¼Œè¦ä¹ˆå…¨ä¸å¡«
            // æ›´æ–°é€Ÿç‡é™åˆ¶å‚æ•°åç§°
            const rateLimitType = document.getElementById('rate-limit-type').value;
            const rateLimitInput = document.getElementById('rate-limit-value');
            rateLimitInput.name = rateLimitType; // åŠ¨æ€è®¾ç½®å‚æ•°åä¸º rpm æˆ– qps
            
            const apiKey = document.getElementById('openai-api-key').value.trim();
            const model = document.getElementById('openai-model').value.trim();
            const baseUrl = document.getElementById('openai-base-url').value.trim();
            
            const filledCount = [apiKey, model, baseUrl].filter(v => v !== '').length;
            
            if (filledCount > 0 && filledCount < 3) {
                showMessage('error', 'âŒ OpenAI é…ç½®é”™è¯¯ï¼šAPI Keyã€æ¨¡å‹å’Œ Base URL å¿…é¡»å…¨éƒ¨å¡«å†™æˆ–å…¨éƒ¨ç•™ç©ºï¼ˆç•™ç©ºä½¿ç”¨ç¯å¢ƒå˜é‡é»˜è®¤é…ç½®ï¼‰');
                submitBtn.disabled = false;
                submitText.style.display = 'inline';
                submitSpinner.style.display = 'none';
                return;
            }

            const formData = new FormData(form);
            
            // ç¡®ä¿æœªé€‰ä¸­çš„å¤é€‰æ¡†ä¸ä¼šè¢«æäº¤
            const checkboxes = form.querySelectorAll('input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                if (!checkbox.checked) {
                    formData.delete(checkbox.name);
                }
            });
            
            // ç§»é™¤ç©ºå€¼å­—æ®µï¼Œé¿å…ä¼ é€’æ— æ•ˆå‚æ•°
            for (let [key, value] of [...formData.entries()]) {
                if (value === '' || value === 'null' || value === 'undefined') {
                    formData.delete(key);
                }
            }

            try {
                const response = await fetch('/api/tasks/submit', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (data.success) {
                    showMessage('success', `âœ… ä»»åŠ¡æäº¤æˆåŠŸï¼ä»»åŠ¡ID: ${data.task_id}`);
                    form.reset();
                    
                    setTimeout(() => {
                        window.location.href = `detail.html?id=${data.task_id}`;
                    }, 1500);
                } else {
                    showMessage('error', 'âŒ ä»»åŠ¡æäº¤å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                showMessage('error', 'âŒ ç½‘ç»œé”™è¯¯: ' + error.message);
            } finally {
                submitBtn.disabled = false;
                submitText.style.display = 'inline';
                submitSpinner.style.display = 'none';
            }
        });

        function showMessage(type, text) {
            message.className = `message ${type}`;
            message.textContent = text;
            message.style.display = 'block';
            
            setTimeout(() => {
                message.style.display = 'none';
            }, 5000);
        }
    </script>
</body>
</html>
